<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>TEST</title>
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/game.css">
    </head>
    <body>
        <div class="center-content">
            <h2 id="name"></h2>
            <div id="list" class="div-group">
            </div>
            <form id="addPlayer">
                <input type="text" id="playerName">
                <input type="submit" value="AJOUTER">
            </form>
            <button id="start">DÃ©marrer la partie</button>
        </div>
    </body>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

    <script src="js/DungeonGenerator/utils/array2d.js"></script>
    <script src="js/DungeonGenerator/utils/index.js"></script>
    <script src="js/DungeonGenerator/utils/rectangle.js"></script>
    <script src="js/DungeonGenerator/utils/random.js"></script>
    <script src="js/DungeonGenerator/const.js"></script>
    <script src="js/DungeonGenerator/pieces/piece.js"></script>
    <script src="js/DungeonGenerator/pieces/room.js"></script>
    <script src="js/DungeonGenerator/pieces/corridor.js"></script>
    <script src="js/DungeonGenerator/generators/generator.js"></script>
    <script src="js/DungeonGenerator/generators/dungeon.js"></script>
    <script src="js/DungeonGenerator/main.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/game.js"></script>
    <script>
        initGun();

        var user;
        var game;
        var players = [];

        getUser().then(userNode => {
            user = userNode;
            user.get("gameId").val(gameId => {
                game = gun.get("games").get(gameId);
                game.get("name").val(name => {
                    document.getElementById("name").innerText = name;
                });
                game.get("players").map().on((player, id) => {
                    if (players[id] === undefined) {
                        players[id] = player;
                        var elt = document.createElement("div");
                        elt.innerHTML = player.name;
                        document.getElementById("list").appendChild(elt);
                    }
                });
                game.get("start").on(start => {
                    if (start && start == true) {
                        game.val(gameVal => {
                            gameVal.board = JSON.stringify(buildClassic());
                            game.put(gameVal, () => {
                                window.location.href = "./board.html";
                            });
                        });
                    }
                });
            });
        });

        document.querySelector("#addPlayer")
        .addEventListener("submit", function(e) {
            e.preventDefault();
            var playerName = document.getElementById("playerName").value;
            document.getElementById("playerName").value = "";
            initPlayer(playerName).then(player => {
                player.val(playerVal => {
                    playerVal.userId = localStorage["dungeon-userId"];
                    player.put(playerVal);
                    game.get("players").set(player);
                });
            });
        });

        document.getElementById("start").onclick = function() {
            game.val(gameVal => {
                gameVal.start = true;
                game.put(gameVal);
            });
        };
    </script>
</html>